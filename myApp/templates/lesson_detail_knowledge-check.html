{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ lesson.title }} — Lesson 14</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{ --ink:#0b1027; --muted:#64748b; --brand:#18AFAB; }
    .ink{color:var(--ink)} .muted{color:var(--muted)} .brand{color:var(--brand)}
    .card{background:#fff; box-shadow:0 10px 30px rgba(2,6,23,.06)}
    .progress{height:3px; background:linear-gradient(90deg,var(--brand),#22c55e)}
    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.375rem .75rem;border-radius:.75rem;border:1px solid}
    .q{border:1px solid #e5e7eb; border-radius:1rem; padding:1rem}
    .correct{background:#ecfdf5; border-color:#86efac}
    .wrong{background:#fef2f2; border-color:#fecaca}
    .explain{display:none}
    .explain.show{display:block}
  </style>
</head>
<body class="bg-white text-slate-900 antialiased">
    {% include "partials/chatbot.html" %}
  <!-- progress -->
  <div id="progressBar" class="fixed top-0 left-0 right-0 z-50 progress" style="width:0%"></div>

  <!-- Breadcrumb -->
  <nav class="border-b bg-white/80 backdrop-blur sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
      <ol class="flex items-center gap-2 text-sm text-slate-500">
        <li><a href="{% url 'lesson6' %}" class="hover:text-slate-900">Lesson 6 Overview</a></li>
        <li class="text-slate-400">/</li>
        <li class="text-slate-900 font-semibold">{{ lesson.title }}</li>
      </ol>
      <div class="hidden sm:flex items-center gap-2 text-sm">
        <button class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">
          <i class="fa-regular fa-bookmark mr-2"></i> Save
        </button>
        <button class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50">
          <i class="fa-solid fa-share-nodes mr-2"></i> Share
        </button>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <header>
    <div class="max-w-6xl mx-auto px-6 pt-10 pb-6">
      <p class="uppercase tracking-[.25em] text-xs brand font-semibold">Lesson 14</p>
      <h1 class="text-3xl md:text-4xl font-extrabold ink leading-tight mt-1">
        {{ lesson.subtitle|default:lesson.title }}
      </h1>
      <p class="muted mt-3 max-w-3xl">
        Five quick questions to validate mastery of mover boundaries, “freebie” risks, and client education.
      </p>
      <div class="mt-4 flex flex-wrap items-center gap-2">
        <span class="pill bg-emerald-50 text-emerald-700 border-emerald-200 text-xs md:text-sm">
          <i class="fa-regular fa-clock"></i> {{ lesson.meta.duration|default:"6–10 mins" }}
        </span>
        <span class="pill bg-sky-50 text-sky-700 border-sky-200 text-xs md:text-sm">
          <i class="fa-solid fa-signal"></i> {{ lesson.meta.level|default:"All Agents" }}
        </span>
      </div>
    </div>
  </header>

  <!-- Body -->
  <main class="max-w-6xl mx-auto px-6 pb-16 grid lg:grid-cols-12 gap-8">
    <article class="lg:col-span-8">
      <div class="card rounded-2xl p-6 md:p-8">
        <div class="prose max-w-none">
          <h2 class="text-2xl md:text-3xl font-bold ink">Purpose</h2>
          <p class="text-slate-700">Reinforce learning by testing both factual knowledge and applied decision-making.</p>

          <hr class="my-8 border-slate-200"/>

          <form id="quiz" class="grid gap-5">
            <!-- Q1 -->
            <fieldset class="q" data-q="1" data-answer="c">
              <legend class="font-semibold">1) Which task is within a mover’s professional scope?</legend>
              <label class="block mt-2"><input type="radio" name="q1" value="a"> a) Disconnecting a washing machine</label>
              <label class="block"><input type="radio" name="q1" value="b"> b) Taking down a chandelier</label>
              <label class="block"><input type="radio" name="q1" value="c"> c) Disassembling a bed frame</label>
              <label class="block"><input type="radio" name="q1" value="d"> d) Reconnecting a gas dryer</label>
              <p class="explain mt-2 text-sm text-slate-700">Correct: <strong>Disassembling a bed frame</strong> is in scope; utilities are not.</p>
            </fieldset>

            <!-- Q2 -->
            <fieldset class="q" data-q="2" data-answer="false">
              <legend class="font-semibold">2) T/F: If movers disconnect a fridge water line and it leaks, their insurance covers the repairs.</legend>
              <label class="block mt-2"><input type="radio" name="q2" value="true"> True</label>
              <label class="block"><input type="radio" name="q2" value="false"> False</label>
              <p class="explain mt-2 text-sm text-slate-700">Correct: <strong>False</strong> — outside scope means claims can be denied.</p>
            </fieldset>

            <!-- Q3 -->
            <fieldset class="q" data-q="3" data-answer="b">
              <legend class="font-semibold">3) Which phrase is a red flag?</legend>
              <label class="block mt-2"><input type="radio" name="q3" value="a"> a) “Can you label these boxes?”</label>
              <label class="block"><input type="radio" name="q3" value="b"> b) “While you’re here, could you just…”</label>
              <label class="block"><input type="radio" name="q3" value="c"> c) “Do you have extra moving blankets?”</label>
              <label class="block"><input type="radio" name="q3" value="d"> d) “Where should I sign the insurance form?”</label>
              <p class="explain mt-2 text-sm text-slate-700">Correct: <strong>b)</strong> signals a risky “free favor.”</p>
            </fieldset>

            <!-- Q4 Matching -->
            <fieldset class="q" data-q="4" data-answer="a:Movers;b:Licensed Professional;c:Client;d:Movers;e:Licensed Professional">
              <legend class="font-semibold">4) Match task → responsibility</legend>
              <div class="mt-2 grid md:grid-cols-2 gap-3 text-sm">
                <div>
                  <div class="font-medium">a) Transporting sofas and boxes</div>
                  <select class="mt-1 w-full rounded-lg border border-slate-300 px-2 py-1" data-item="a">
                    <option value="">Select…</option>
                    <option>Movers</option>
                    <option>Licensed Professional</option>
                    <option>Client</option>
                  </select>
                </div>
                <div>
                  <div class="font-medium">b) Disconnecting gas appliances</div>
                  <select class="mt-1 w-full rounded-lg border border-slate-300 px-2 py-1" data-item="b">
                    <option value="">Select…</option>
                    <option>Movers</option>
                    <option>Licensed Professional</option>
                    <option>Client</option>
                  </select>
                </div>
                <div>
                  <div class="font-medium">c) Moving jewelry and cash</div>
                  <select class="mt-1 w-full rounded-lg border border-slate-300 px-2 py-1" data-item="c">
                    <option value="">Select…</option>
                    <option>Movers</option>
                    <option>Licensed Professional</option>
                    <option>Client</option>
                  </select>
                </div>
                <div>
                  <div class="font-medium">d) Packing glassware</div>
                  <select class="mt-1 w-full rounded-lg border border-slate-300 px-2 py-1" data-item="d">
                    <option value="">Select…</option>
                    <option>Movers</option>
                    <option>Licensed Professional</option>
                    <option>Client</option>
                  </select>
                </div>
                <div>
                  <div class="font-medium">e) Removing a chandelier</div>
                  <select class="mt-1 w-full rounded-lg border border-slate-300 px-2 py-1" data-item="e">
                    <option value="">Select…</option>
                    <option>Movers</option>
                    <option>Licensed Professional</option>
                    <option>Client</option>
                  </select>
                </div>
              </div>
              <p class="explain mt-2 text-sm text-slate-700">Correct mapping: a) Movers • b) Licensed Professional • c) Client • d) Movers • e) Licensed Professional.</p>
            </fieldset>

            <!-- Q5 Scenario -->
            <fieldset class="q" data-q="5" data-answer="b">
              <legend class="font-semibold">5) Client asks movers to remove a chandelier & reconnect it at new home. What should the Realtor do?</legend>
              <label class="block mt-2"><input type="radio" name="q5" value="a"> a) Agree, if movers are careful.</label>
              <label class="block"><input type="radio" name="q5" value="b"> b) Decline; explain movers aren’t licensed electricians. Arrange a pro.</label>
              <label class="block"><input type="radio" name="q5" value="c"> c) Let movers decide.</label>
              <label class="block"><input type="radio" name="q5" value="d"> d) Ask movers to try, but supervise.</label>
              <p class="explain mt-2 text-sm text-slate-700">Correct: <strong>b)</strong> — electrical = licensed professional.</p>
            </fieldset>

            <!-- Actions -->
            <div class="flex flex-wrap gap-3 mt-2">
              <button type="button" id="submitQuiz" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:opacity-90">
                Submit
              </button>
              <button type="button" id="resetQuiz" class="px-4 py-2 rounded-xl border border-slate-300 font-semibold hover:bg-slate-50">
                Retake
              </button>
            </div>
          </form>

          <!-- Results -->
          <div id="results" class="mt-6 p-4 rounded-2xl border border-slate-200 hidden">
            <div class="flex items-center justify-between">
              <p class="font-semibold">Your Score: <span id="score">0</span>/5</p>
              <p class="text-sm text-slate-600">Passing criteria: 4/5</p>
            </div>
            <p id="passMsg" class="mt-2 text-slate-700"></p>
          </div>

          <hr class="my-8 border-slate-200"/>

          <h2 class="text-2xl md:text-3xl font-bold ink">Feedback Guidance</h2>
          <ul class="list-disc pl-6 text-slate-700">
            <li>For factual misses, restate the rule.</li>
            <li>For scenario misses, explain the liability and the correct script.</li>
          </ul>

          <div class="mt-6 p-5 rounded-xl bg-emerald-50 border border-emerald-200">
            <p class="text-slate-800"><strong>Key Takeaway:</strong> Scoring 4+ shows you can recall, apply, and communicate mover boundaries with confidence.</p>
          </div>
        </div>

        <!-- CTA row -->
        <div class="mt-8 flex flex-wrap gap-3">
          <a href="{% url 'lesson6' %}"
             class="px-5 py-3 rounded-xl border border-slate-300 font-semibold hover:bg-slate-50">
            <i class="fa-solid fa-list mr-2"></i> Back to Overview
          </a>
          {% if next_topic %}
          <a href="{% url 'lesson_detail' next_topic.slug %}"
             class="px-5 py-3 rounded-xl bg-emerald-600 text-white font-semibold hover:opacity-90">
            Next Lesson
          </a>
          {% endif %}
        </div>
      </div>

      <!-- Prev/Next -->
      <div class="mt-6 flex items-center justify-between text-sm text-slate-600">
        {% if prev_topic %}
          <a href="{% url 'lesson_detail' prev_topic.slug %}" class="hover:text-slate-900"><i class="fa-solid fa-arrow-left-long mr-2"></i> {{ prev_topic.title }}</a>
        {% else %}
          <span></span>
        {% endif %}
        {% if next_topic %}
          <a href="{% url 'lesson_detail' next_topic.slug %}" class="hover:text-slate-900">{{ next_topic.title }} <i class="fa-solid fa-arrow-right-long ml-2"></i></a>
        {% endif %}
      </div>
    </article>

    <!-- Sidebar -->
    <aside class="lg:col-span-4 lg:sticky lg:top-20 h-max">
      <div class="card rounded-2xl p-5 mb-5">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold">On this page</h4>
          <span class="text-xs text-slate-500">Lesson 14</span>
        </div>
        <nav id="toc" class="space-y-2 text-sm"></nav>
      </div>

      <div class="card rounded-2xl p-5">
        <h4 class="font-semibold mb-3">All topics</h4>
        <ul class="space-y-1 text-sm">
          {% for t in all_topics %}
          <li>
            <a href="{% url 'lesson_detail' t.slug %}"
               class="block px-3 py-2 rounded-lg border border-transparent hover:border-slate-200 hover:bg-slate-50 {% if t.slug == slug %}bg-slate-100 border-slate-200{% endif %}">
              {{ forloop.counter }}. {{ t.title }}
            </a>
          </li>
          {% endfor %}
        </ul>
        <a href="{% url 'lesson6' %}" class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm">
          <i class="fa-solid fa-list"></i> Back to Overview
        </a>
      </div>
    </aside>
  </main>

  <footer class="py-10 border-t">
    <div class="max-w-6xl mx-auto px-6 text-xs text-slate-500">
      © <span id="year"></span> Esposito Courses • Lesson 14
    </div>
  </footer>

  <script>
    // year + progress
    document.getElementById('year').textContent = new Date().getFullYear();
    const pb = document.getElementById('progressBar');
    window.addEventListener('scroll', () => {
      const h = document.documentElement;
      const scrolled = (h.scrollTop) / (h.scrollHeight - h.clientHeight);
      pb.style.width = (scrolled * 100) + '%';
    });

    // TOC
    const content = document.querySelector('article'), toc = document.getElementById('toc');
    const heads = content.querySelectorAll('h2'); const ul = document.createElement('ul'); ul.className="space-y-1";
    heads.forEach(h=>{ if(!h.id){ h.id=h.textContent.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
      const li=document.createElement('li'); li.innerHTML=`<a href="#${h.id}" class="block px-3 py-2 rounded-lg border border-transparent hover:border-slate-200 hover:bg-slate-50">${h.textContent}</a>`;
      ul.appendChild(li);
    }); toc.appendChild(ul);

    // Quiz logic
    const PASS = 4;
    const quiz = document.getElementById('quiz');
    const results = document.getElementById('results');
    const scoreEl = document.getElementById('score');
    const passMsg = document.getElementById('passMsg');
    const KEY='esposito_quiz14_v1';

    function grade(){
      let score = 0;

      // Q1,2,3,5 radios
      [1,2,3,5].forEach(n=>{
        const fs = quiz.querySelector(`[data-q="${n}"]`);
        const ans = fs.dataset.answer;
        const val = (quiz.querySelector(`input[name="q${n}"]:checked`)||{}).value;
        const ok = val === ans;
        fs.classList.remove('correct','wrong');
        fs.classList.add(ok ? 'correct':'wrong');
        fs.querySelector('.explain').classList.add('show');
        if(ok) score++;
      });

      // Q4 matching
      const fs4 = quiz.querySelector('[data-q="4"]');
      const correctMap = Object.fromEntries(
        fs4.dataset.answer.split(';').map(pair => pair.split(':'))
      );
      let allOk = true;
      Object.keys(correctMap).forEach(k=>{
        const sel = fs4.querySelector(`[data-item="${k}"]`);
        if(!sel) return;
        const ok = sel.value === correctMap[k];
        if(!ok) allOk = false;
      });
      fs4.classList.remove('correct','wrong');
      fs4.classList.add(allOk ? 'correct':'wrong');
      fs4.querySelector('.explain').classList.add('show');
      if(allOk) score++;

      scoreEl.textContent = score;
      results.classList.remove('hidden');
      passMsg.textContent = (score >= PASS)
        ? "Great work! You’ve demonstrated mastery (4/5+)."
        : "Close! Review the explanations above and retake to hit 4/5.";
      // persist
      localStorage.setItem(KEY, JSON.stringify({score, ts: Date.now()}));
    }

    document.getElementById('submitQuiz').addEventListener('click', grade);

    document.getElementById('resetQuiz').addEventListener('click', ()=>{
      // reset radios/selects
      quiz.querySelectorAll('input[type="radio"]').forEach(r=> r.checked=false);
      quiz.querySelectorAll('select').forEach(s=> s.selectedIndex=0);
      // visuals
      quiz.querySelectorAll('.q').forEach(q=>{ q.classList.remove('correct','wrong'); q.querySelector('.explain').classList.remove('show'); });
      results.classList.add('hidden'); scoreEl.textContent='0'; passMsg.textContent='';
    });

    // restore last score (optional)
    try{
      const saved = JSON.parse(localStorage.getItem(KEY)||'{}');
      if(saved.score !== undefined){
        // show last result hint (non-invasive)
        const hint = document.createElement('div');
        hint.className='mt-2 text-xs text-slate-500';
        hint.textContent = `Last attempt: ${saved.score}/5`;
        results.parentNode.insertBefore(hint, results);
      }
    }catch(e){}
  </script>
</body>
</html>
